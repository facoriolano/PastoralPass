<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>PastoralPass - Cloud</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- HTML5-QRCode (Leitor de Câmera) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Polyfill para evitar erros de ambiente -->
    <script>
      window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Import Map: Trocando para Gstatic (Oficial Google) para garantir estabilidade do Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0"
      }
    }
    </script>
    
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-in { animation: fadeIn 0.4s ease-out; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      
      .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Ajuste para o leitor de QR Code não quebrar o layout */
      #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
      #reader video { object-fit: cover; width: 100%; height: 100%; border-radius: 12px; }
    </style>
  </head>
  <body>
    <!-- Loader Estático -->
    <div id="root">
      <div class="min-h-screen flex flex-col items-center justify-center bg-gray-50 text-gray-500">
        <div class="loader mb-4"></div>
        <p>Iniciando Sistema...</p>
        <p class="text-xs mt-2 text-gray-400">Versão Estável 4.4 (Custom Code)</p>
        
        <button id="reset-btn" onclick="localStorage.clear(); window.location.reload()" style="display:none" class="mt-8 text-xs text-red-500 underline cursor-pointer">
           Demorando muito? Clique para resetar
        </button>
      </div>
    </div>
    
    <!-- Display de Erro -->
    <div id="error-display" style="display:none; padding: 20px; color: white; background: #ef4444; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; overflow:auto;">
      <h2 style="font-weight: bold; font-size: 1.5rem; margin-bottom: 20px;">Ops! Algo deu errado.</h2>
      <p style="margin-bottom: 10px;">Tente recarregar a página. Se o erro persistir, limpe o cache.</p>
      <pre id="error-message" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; font-size: 0.8rem;"></pre>
      <button onclick="localStorage.clear(); window.location.reload()" style="margin-top: 20px; padding: 12px 24px; background: white; color: #ef4444; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">
        Limpar Dados e Recarregar
      </button>
    </div>

    <script>
      setTimeout(() => {
        const btn = document.getElementById('reset-btn');
        if(btn) btn.style.display = 'block';
      }, 5000);

      window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('root').style.display = 'none';
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-message').innerText = message + '\n\nSource: ' + source + ':' + lineno;
      };
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module" data-presets="react">
      import React, { useState, useEffect, useMemo, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { 
        getFirestore, collection, addDoc, deleteDoc, doc, updateDoc,
        query, where, onSnapshot, orderBy, serverTimestamp 
      } from 'firebase/firestore';
      
      import { 
        Home, Users, ClipboardList, PieChart, Github, Scan, X, 
        CheckCircle, AlertTriangle, Plus, Trash2, Search, QrCode,
        UserCheck, UserX, Calendar, Sparkles, ScanLine, Download, 
        Check, X as XIcon, Settings, Database, Key, HelpCircle, ArrowRight, ExternalLink, Camera, Loader2, Edit2
      } from 'lucide-react';
      
      import { 
        BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid 
      } from 'recharts';

      const CONFIG_KEY = 'pastoral_config_v5';

      const PastoralType = {
        CATEQUESE: "Catequese Infantil",
        CRISMA: "Crisma",
        EUCARISTIA: "Eucaristia",
        JOVENS: "Grupo de Jovens",
        OUTROS: "Outros"
      };

      const SetupScreen = ({ onSave }) => {
        const [apiKey, setApiKey] = useState('');
        const [fbConfig, setFbConfig] = useState('');
        const [error, setError] = useState('');
        
        const handleSave = () => {
          try {
            let configStr = fbConfig.trim();
            configStr = configStr.replace(/\/\/.*$/gm, '');
            if (configStr.includes('firebaseConfig')) {
                const match = configStr.match(/firebaseConfig\s*=\s*({[\s\S]*?});?/);
                if (match) configStr = match[1];
            } else if (!configStr.trim().startsWith('{')) {
                 const firstBrace = configStr.indexOf('{');
                 const lastBrace = configStr.lastIndexOf('}');
                 if (firstBrace !== -1 && lastBrace !== -1) configStr = configStr.substring(firstBrace, lastBrace + 1);
            }
            let parsed;
            try { parsed = new Function('return ' + configStr)(); } 
            catch (e) { if (!configStr.startsWith('{')) parsed = new Function('return {' + configStr + '}')(); else throw e; }
            if (!parsed || !parsed.projectId) throw new Error("Configuração incompleta.");

            localStorage.setItem(CONFIG_KEY, JSON.stringify({ geminiKey: apiKey, firebase: parsed }));
            window.location.reload(); 
          } catch (e) {
            console.error(e);
            setError("Erro ao ler código. Certifique-se de copiar o bloco: const firebaseConfig = { ... }");
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-900 to-slate-900 font-sans">
            <div className="bg-white rounded-2xl p-6 md:p-8 max-w-2xl w-full shadow-2xl animate-in">
              <div className="flex items-center gap-3 mb-6 border-b pb-4">
                <div className="p-3 bg-blue-100 rounded-lg text-blue-700"><Database size={24}/></div>
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">Conectar PastoralPass</h1>
                  <p className="text-gray-500 text-sm">Cole as chaves do seu banco de dados Firebase</p>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-6 md:gap-8">
                <div className="space-y-4">
                  <div>
                     <label className="text-xs uppercase font-bold text-gray-400 mb-2 block">Instruções</label>
                     <ol className="text-xs text-gray-600 space-y-2 list-decimal pl-4 bg-gray-50 p-3 rounded-lg border">
                        <li>No Firebase, vá em <strong>Configuração do SDK</strong>.</li>
                        <li>Marque a bolinha <strong>Config</strong>.</li>
                        <li>Copie o código: <code>const firebaseConfig = &#123; ... &#125;</code></li>
                     </ol>
                  </div>
                  <div>
                    <label className="text-xs uppercase font-bold text-gray-400 mb-1 block">Cole o código aqui:</label>
                    <textarea value={fbConfig} onChange={e => {setFbConfig(e.target.value); setError('');}} placeholder='const firebaseConfig = { ... }' className="w-full h-32 p-3 border rounded-lg text-xs font-mono bg-gray-900 text-green-400 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                    {error && <p className="text-red-500 text-xs font-bold mt-1">{error}</p>}
                  </div>
                </div>
                <div className="space-y-4 border-l pl-0 md:pl-8 border-gray-100 flex flex-col justify-between">
                   <div>
                    <label className="text-xs uppercase font-bold text-gray-400 mb-1 block">Opcional: Gemini API Key</label>
                    <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full p-3 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Para usar a IA (opcional)"/>
                  </div>
                  <button onClick={handleSave} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg hover:shadow-blue-500/30 flex justify-center items-center gap-2">Conectar Agora <ArrowRight size={18}/></button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      const App = () => {
        const [config, setConfig] = useState(null);
        const [db, setDb] = useState(null);
        const [initError, setInitError] = useState(null);
        const [activeTab, setActiveTab] = useState('dashboard');
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [scannerOpen, setScannerOpen] = useState(false);
        const [students, setStudents] = useState([]);
        const [attendance, setAttendance] = useState([]);
        const [aiLoading, setAiLoading] = useState(false);
        const [aiResult, setAiResult] = useState('');

        useEffect(() => {
          const stored = localStorage.getItem(CONFIG_KEY);
          if (stored) {
            try {
              const parsed = JSON.parse(stored);
              setConfig(parsed);
              if (!parsed.firebase) throw new Error("Configuração do Firebase inválida.");
              
              // Verifica se o Firebase já foi inicializado
              let firebaseApp;
              try {
                firebaseApp = initializeApp(parsed.firebase);
              } catch (error) {
                // Se der erro de "já existe", tenta pegar a instância padrão ou ignora
                if (error.code === 'app/duplicate-app') {
                   // Hack para recuperar a instancia se ja existir (em hot reload)
                   // Em produção real, o reload da pagina limpa isso.
                   window.location.reload();
                   return;
                } else {
                   throw error;
                }
              }

              const firestore = getFirestore(firebaseApp);
              setDb(firestore);
              const unsubStudents = onSnapshot(collection(firestore, 'alunos'), (snap) => setStudents(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
              const unsubAttendance = onSnapshot(query(collection(firestore, 'presencas'), orderBy('timestamp', 'desc')), (snap) => setAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() }))), (error) => {
                  console.error("Firestore Error:", error);
                  if (error.code === 'permission-denied') alert("⚠️ PERMISSÃO NEGADA\n\nSeu banco de dados foi criado no Modo de Produção (Bloqueado).\n\nVá no console do Firebase > Firestore > Regras e altere 'allow read, write: if false' para 'if true'.");
              });
              return () => { unsubStudents(); unsubAttendance(); };
            } catch(e) { console.error("Init Error", e); setInitError(e.message || "Erro desconhecido na inicialização"); }
          }
        }, []);

        const handleAddStudent = async (data) => {
          if (!db) return;
          const qrCodeValue = data.qrCodeValue && data.qrCodeValue.trim() !== '' 
              ? data.qrCodeValue 
              : Math.random().toString(36).substr(2, 9).toUpperCase();
              
          if (data.id) {
             // Edição
             await updateDoc(doc(db, 'alunos', data.id), { 
                 name: data.name, 
                 pastoral: data.pastoral, 
                 qrCodeValue: qrCodeValue
             });
          } else {
             // Criação
             await addDoc(collection(db, 'alunos'), { 
                 name: data.name, 
                 pastoral: data.pastoral, 
                 createdAt: serverTimestamp(), 
                 qrCodeValue: qrCodeValue 
             });
          }
        };

        const handleDeleteStudent = async (id) => { if(!db || !confirm("Excluir aluno permanentemente?")) return; await deleteDoc(doc(db, 'alunos', id)); };

        const handleMarkAttendance = async (scannedCode) => {
          if (!db) return;
          const cleanCode = scannedCode.trim();
          
          // Tenta encontrar por código exato ou ID
          const student = students.find(s => s.qrCodeValue === cleanCode || s.id === cleanCode);
          
          if (!student) throw new Error(`Aluno não encontrado para o código: ${cleanCode}`);
          
          const today = new Date().toISOString().split('T')[0];
          const already = attendance.find(a => a.studentId === student.id && a.dateString === today);
          
          if (already) throw new Error(`${student.name} já registrado hoje!`);
          
          await addDoc(collection(db, 'presencas'), { 
              studentId: student.id, 
              studentName: student.name, 
              pastoral: student.pastoral, 
              timestamp: Date.now(), 
              dateString: today 
          });
          return student.name;
        };

        const handleAiAnalysis = async () => {
            if (!config?.geminiKey) return alert("Configure a API Key para usar este recurso.");
            setAiLoading(true);
            try {
                const prompt = `Analise estes dados de igreja: Temos ${students.length} alunos cadastrados. Hoje tivemos ${attendance.filter(a => a.dateString === new Date().toISOString().split('T')[0]).length} presenças. Gere 3 insights curtos e motivadores.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${config.geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) setAiResult(data.candidates[0].content.parts[0].text);
                else throw new Error("Falha na resposta da IA");
            } catch (err) { setAiResult("Erro ao conectar com a IA. Verifique sua chave de API."); }
            setAiLoading(false);
        };

        if (initError) return <div className="min-h-screen flex items-center justify-center p-4 bg-red-50 text-red-900"><div className="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border border-red-200"><div className="flex items-center gap-3 mb-4 text-red-600"><AlertTriangle size={32}/><h1 className="text-xl font-bold">Erro de Inicialização</h1></div><p className="mb-4 text-sm bg-red-50 p-3 rounded border border-red-100 font-mono break-all">{initError}</p><p className="mb-6 text-gray-600 text-sm">A configuração salva parece estar inválida ou o Firebase bloqueou a conexão.</p><button onClick={() => { localStorage.removeItem(CONFIG_KEY); window.location.reload(); }} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors">Resetar e Tentar Novamente</button></div></div>;

        if (!config) return <SetupScreen />;
        if (!db) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold flex-col gap-4"><div className="loader"></div><p>Sincronizando com a Nuvem...</p><button onClick={() => {localStorage.removeItem(CONFIG_KEY); window.location.reload()}} className="text-xs text-red-400 underline mt-4 hover:text-red-600">Cancelar e Resetar</button></div>;

        const Dashboard = () => {
            const today = new Date().toISOString().split('T')[0];
            const presentToday = attendance.filter(a => a.dateString === today).length;
            const chartData = useMemo(() => {
                const days = [];
                for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const ds = d.toISOString().split('T')[0]; days.push({ name: d.toLocaleDateString('pt-BR', {weekday: 'short'}), value: attendance.filter(a => a.dateString === ds).length }); }
                return days;
            }, [attendance]);

            return (
                <div className="space-y-6 animate-in">
                    <h2 className="text-2xl font-bold text-gray-800">Painel Geral</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white p-5 rounded-xl border border-blue-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Total Alunos</p><h3 className="text-3xl font-bold text-blue-600 mt-1">{students.length}</h3></div>
                        <div className="bg-white p-5 rounded-xl border border-green-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Presentes Hoje</p><h3 className="text-3xl font-bold text-green-600 mt-1">{presentToday}</h3></div>
                        <div className="bg-white p-5 rounded-xl border border-red-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Faltantes</p><h3 className="text-3xl font-bold text-red-600 mt-1">{Math.max(0, students.length - presentToday)}</h3></div>
                        <div className="bg-white p-5 rounded-xl border border-purple-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Frequência</p><h3 className="text-3xl font-bold text-purple-600 mt-1">{students.length ? Math.round((presentToday/students.length)*100) : 0}%</h3></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm h-72"><ResponsiveContainer width="100%" height="100%"><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6"/><XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill:'#9ca3af', fontSize:12}}/><Tooltip cursor={{fill: '#f9fafb'}} contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 6px -1px rgb(0 0 0 / 0.1)'}}/><Bar dataKey="value" fill="#3b82f6" radius={[4,4,0,0]} barSize={40}/></BarChart></ResponsiveContainer></div>
                </div>
            );
        };

        const StudentsList = () => {
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ id: null, name: '', pastoral: PastoralType.CATEQUESE, qrCodeValue: '' });
            const [search, setSearch] = useState('');
            const filtered = students.filter(s => s.name.toLowerCase().includes(search.toLowerCase()));
            
            const openEdit = (s) => {
                setForm({ id: s.id, name: s.name, pastoral: s.pastoral, qrCodeValue: s.qrCodeValue || '' });
                setModal(true);
            };

            return (
                <div className="space-y-6 animate-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800">Alunos</h2><button onClick={() => {setForm({id: null, name:'', pastoral: PastoralType.CATEQUESE, qrCodeValue: ''}); setModal(true)}} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition font-medium text-sm"><Plus size={18}/> Novo Aluno</button></div>
                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                        <div className="p-4 border-b bg-gray-50/50"><div className="relative"><Search className="absolute left-3 top-2.5 text-gray-400" size={18}/><input type="text" placeholder="Buscar aluno..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-10 p-2 border rounded-lg bg-white text-sm focus:ring-2 focus:ring-blue-100 outline-none"/></div></div>
                        <div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-gray-50 text-gray-600 text-xs uppercase font-bold"><tr><th className="p-4">Nome</th><th className="p-4">Pastoral</th><th className="p-4">ID / QR</th><th className="p-4 text-right"></th></tr></thead><tbody className="divide-y text-sm">{filtered.map(s => (<tr key={s.id} className="hover:bg-gray-50 group"><td className="p-4 font-medium text-gray-900">{s.name}</td><td className="p-4"><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded-md text-xs font-semibold">{s.pastoral}</span></td><td className="p-4 font-mono text-gray-400 text-xs">{s.qrCodeValue}</td><td className="p-4 text-right flex justify-end gap-2"><button onClick={() => openEdit(s)} className="text-gray-300 hover:text-blue-600 transition"><Edit2 size={16}/></button><button onClick={() => handleDeleteStudent(s.id)} className="text-gray-300 hover:text-red-600 transition"><Trash2 size={16}/></button></td></tr>))}{filtered.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">Nenhum aluno encontrado.</td></tr>}</tbody></table></div>
                    </div>
                    {modal && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl p-6 w-full max-w-sm animate-in shadow-2xl"><h3 className="font-bold text-lg mb-4">{form.id ? 'Editar Aluno' : 'Adicionar Aluno'}</h3><div className="space-y-4"><input className="w-full p-3 border rounded-lg text-sm" placeholder="Nome Completo" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /><select className="w-full p-3 border rounded-lg bg-white text-sm" value={form.pastoral} onChange={e => setForm({...form, pastoral: e.target.value})}>{Object.values(PastoralType).map(p => <option key={p} value={p}>{p}</option>)}</select><input className="w-full p-3 border rounded-lg text-sm bg-gray-50" placeholder="Código do Crachá/QR (Opcional)" value={form.qrCodeValue} onChange={e => setForm({...form, qrCodeValue: e.target.value})} /><p className="text-xs text-gray-400">Se deixar vazio, um código aleatório será gerado.</p><div className="flex justify-end gap-2 mt-4 pt-4 border-t"><button onClick={() => setModal(false)} className="px-4 py-2 text-gray-500 text-sm hover:bg-gray-100 rounded-lg">Cancelar</button><button onClick={() => { handleAddStudent(form); setModal(false); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">Salvar</button></div></div></div></div>}
                </div>
            );
        };

        const Reports = () => {
             const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
             const list = useMemo(() => students.map(s => ({ ...s, present: attendance.some(a => a.studentId === s.id && a.dateString === date) })), [students, attendance, date]);
             const exportCsv = () => { const csv = "data:text/csv;charset=utf-8," + ["Nome,Pastoral,Status", ...list.map(l => `${l.name},${l.pastoral},${l.present ? 'PRESENTE' : 'FALTA'}`)].join('\n'); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `relatorio_${date}.csv`; link.click(); };
             return (
                <div className="space-y-6 animate-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800">Relatórios</h2><button onClick={exportCsv} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex gap-2 hover:bg-emerald-700 text-sm font-medium"><Download size={18}/> CSV</button></div>
                    <div className="bg-white p-4 rounded-xl border shadow-sm flex gap-3 items-center w-full md:w-auto self-start"><Calendar className="text-gray-400" size={20}/><input type="date" value={date} onChange={e => setDate(e.target.value)} className="outline-none text-gray-700 font-medium bg-transparent"/></div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-50 text-gray-600 text-xs uppercase font-bold"><tr><th className="p-4">Aluno</th><th className="p-4">Status</th></tr></thead><tbody className="divide-y text-sm">{list.map(l => (<tr key={l.id}><td className="p-4">{l.name}</td><td className="p-4">{l.present ? <span className="text-emerald-600 flex items-center gap-1 font-bold"><Check size={16}/> Presente</span> : <span className="text-red-400 flex items-center gap-1"><XIcon size={16}/> Falta</span>}</td></tr>))}{list.length === 0 && <tr><td colSpan="2" className="p-8 text-center text-gray-400">Sem dados para esta data.</td></tr>}</tbody></table></div>
                </div>
             );
        };

        const ScannerModal = ({ onClose }) => {
            const [val, setVal] = useState('');
            const [status, setStatus] = useState('idle');
            const [msg, setMsg] = useState('');
            const [isScanning, setIsScanning] = useState(false);
            const scannerRef = useRef(null);

            const stopScanner = () => {
                if(scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        scannerRef.current = null;
                        setIsScanning(false);
                    }).catch(err => console.log("Stop error", err));
                }
            };

            const handleClose = () => {
                stopScanner();
                onClose();
            };

            const handleCode = async (code) => {
                stopScanner(); // Para a câmera ao detectar
                try {
                    const name = await handleMarkAttendance(code);
                    setStatus('success');
                    setMsg(name);
                    setTimeout(() => { setStatus('idle'); setVal(''); setMsg(''); handleClose(); }, 1500);
                } catch (err) {
                    setStatus('error');
                    setMsg(err.message);
                }
            };

            const submit = (e) => { e.preventDefault(); if(val) handleCode(val); };

            const startCamera = async () => {
                setIsScanning(true);
                // Pequeno delay para garantir que o elemento #reader existe
                setTimeout(async () => {
                    try {
                        const html5QrCode = new Html5Qrcode("reader");
                        scannerRef.current = html5QrCode;
                        await html5QrCode.start(
                            { facingMode: "environment" },
                            { fps: 10, qrbox: { width: 250, height: 250 } },
                            (decodedText) => { handleCode(decodedText); },
                            (errorMessage) => { /* ignora erros de frame vazio */ }
                        );
                    } catch (err) {
                        console.error(err);
                        setIsScanning(false);
                        alert("Não foi possível acessar a câmera. Verifique as permissões do navegador ou se o site está usando HTTPS.");
                    }
                }, 100);
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                    <button onClick={handleClose} className="absolute top-6 right-6 text-white/50 hover:text-white z-50"><X size={32}/></button>
                    <div className="bg-white p-6 rounded-2xl w-full max-w-sm text-center animate-in shadow-2xl overflow-hidden relative">
                        <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors ${status === 'success' ? 'bg-green-100 text-green-600' : status === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>{status === 'success' ? <CheckCircle size={32}/> : status === 'error' ? <AlertTriangle size={32}/> : <QrCode size={32}/>}</div>
                        <h2 className="text-xl font-bold mb-4 text-gray-800">Registrar Presença</h2>
                        
                        {isScanning ? (
                            <div className="mb-4 relative rounded-xl overflow-hidden bg-black w-full h-64 flex items-center justify-center">
                                <div id="reader" className="w-full h-full"></div>
                                <div className="absolute inset-0 border-2 border-blue-500/50 pointer-events-none"></div>
                                <div className="absolute bottom-2 left-0 w-full text-center text-white text-xs bg-black/50 py-1">Aponte para o QR Code</div>
                            </div>
                        ) : (
                            <button onClick={startCamera} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold mb-6 flex items-center justify-center gap-2 hover:bg-slate-800 transition-all shadow-lg">
                                <Camera size={20}/> Abrir Câmera
                            </button>
                        )}
                        
                        {!isScanning && (
                            <form onSubmit={submit}>
                                <div className="relative"><input id="scanInput" value={val} onChange={e => setVal(e.target.value)} className="w-full border-2 border-gray-200 rounded-xl p-3 text-center text-lg mb-4 focus:border-blue-500 outline-none transition-all font-mono" placeholder="DIGITE O CÓDIGO" autoComplete="off"/></div>
                                <button className="w-full bg-blue-100 text-blue-700 hover:bg-blue-200 py-3 rounded-xl font-bold transition-all">Confirmar Manualmente</button>
                            </form>
                        )}
                        {msg && <p className={`mt-4 font-bold animate-pulse ${status === 'success' ? 'text-green-600' : 'text-red-600'}`}>{msg}</p>}
                    </div>
                </div>
            );
        };

        return (
          <div className="flex min-h-screen bg-gray-50 text-gray-900 font-sans">
            {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden backdrop-blur-sm" onClick={() => setSidebarOpen(false)}/>}
            <aside className={`fixed md:static inset-y-0 left-0 z-40 w-64 bg-slate-900 text-white transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 flex flex-col shadow-xl`}>
                <div className="h-16 flex items-center px-6 border-b border-slate-800 font-bold text-lg tracking-wide bg-slate-950"><div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3"><CheckCircle size={20}/></div>PastoralPass</div>
                <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                    {[{id: 'dashboard', icon: Home, label: 'Painel'},{id: 'students', icon: Users, label: 'Alunos'},{id: 'reports', icon: ClipboardList, label: 'Relatórios'},{id: 'insights', icon: Sparkles, label: 'IA Insights'},{id: 'settings', icon: Settings, label: 'Configuração'}].map(i => (<button key={i.id} onClick={() => {setActiveTab(i.id); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all font-medium ${activeTab === i.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 translate-x-1' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i.icon size={20}/> {i.label}</button>))}
                </nav>
            </aside>
            <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                <header className="h-16 bg-white border-b flex items-center px-4 justify-between md:hidden z-20 sticky top-0"><button onClick={() => setSidebarOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg"><Database size={24}/></button><span className="font-bold text-slate-800">PastoralPass</span><div className="w-8"></div></header>
                <div className="flex-1 overflow-auto p-4 md:p-8 pb-24 scroll-smooth">
                    <div className="max-w-6xl mx-auto">
                        {activeTab === 'dashboard' && <Dashboard />}
                        {activeTab === 'students' && <StudentsList />}
                        {activeTab === 'reports' && <Reports />}
                        {activeTab === 'insights' && (
                            <div className="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 rounded-2xl shadow-xl animate-in relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div><h2 className="text-2xl font-bold flex gap-2 items-center mb-4 relative z-10"><Sparkles className="text-yellow-300"/> Inteligência Pastoral</h2><p className="mb-6 opacity-90 relative z-10 max-w-lg">Utilize o poder do Google Gemini para analisar tendências de frequência e receber conselhos pastorais.</p><button onClick={handleAiAnalysis} disabled={aiLoading} className="relative z-10 bg-white text-indigo-700 px-6 py-3 rounded-xl font-bold hover:shadow-lg transition disabled:opacity-70 flex items-center gap-2">{aiLoading ? <div className="loader w-4 h-4 border-indigo-600 border-t-transparent"></div> : <Sparkles size={18}/>}{aiLoading ? 'Analisando dados...' : 'Gerar Relatório IA'}</button>{aiResult && <div className="mt-8 bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20 leading-relaxed shadow-inner animate-in relative z-10">{aiResult}</div>}
                            </div>
                        )}
                        {activeTab === 'settings' && (
                            <div className="bg-white p-6 rounded-xl border border-red-100 shadow-sm animate-in">
                                <h2 className="text-xl font-bold mb-4 text-red-600 flex items-center gap-2"><AlertTriangle/> Zona de Perigo</h2>
                                <p className="text-gray-600 mb-6">Ao desconectar, você removerá as chaves de acesso deste dispositivo. Os dados no Firebase permanecerão seguros.</p>
                                <button onClick={() => {localStorage.removeItem(CONFIG_KEY); window.location.reload()}} className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl hover:bg-red-100 font-bold w-full md:w-auto transition-colors">Desconectar Banco de Dados</button>
                            </div>
                        )}
                    </div>
                </div>
                <button onClick={() => setScannerOpen(true)} className="fixed bottom-6 right-6 md:bottom-8 md:right-8 bg-blue-600 text-white p-4 rounded-2xl shadow-xl shadow-blue-600/40 hover:scale-110 transition-all active:scale-95 z-30 group"><ScanLine size={32} className="group-hover:rotate-90 transition-transform duration-500"/></button>
            </main>
            {scannerOpen && <ScannerModal onClose={() => setScannerOpen(false)} />}
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
