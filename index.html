<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>PastoralPass - Cloud</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- HTML5-QRCode (Leitor de Câmera) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Polyfill para evitar erros de ambiente -->
    <script>
      window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Import Map: Trocando para Gstatic (Oficial Google) para garantir estabilidade do Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0"
      }
    }
    </script>
    
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-in { animation: fadeIn 0.4s ease-out; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      
      .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Limpeza visual do Scanner */
      #reader {
          width: 100%;
          border-radius: 12px;
          overflow: hidden;
          background: black;
      }
      #reader video {
          width: 100% !important;
          height: 100% !important;
          object-fit: cover;
          border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Loader Estático -->
    <div id="root">
      <div class="min-h-screen flex flex-col items-center justify-center bg-gray-50 text-gray-500">
        <div class="loader mb-4"></div>
        <p>Iniciando Sistema...</p>
        <p class="text-xs mt-2 text-gray-400">Versão 7.5 (Prontuário do Aluno)</p>
        
        <button id="reset-btn" onclick="localStorage.clear(); window.location.reload()" style="display:none" class="mt-8 text-xs text-red-500 underline cursor-pointer">
           Demorando muito? Clique para resetar
        </button>
      </div>
    </div>
    
    <!-- Display de Erro -->
    <div id="error-display" style="display:none; padding: 20px; color: white; background: #ef4444; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; overflow:auto;">
      <h2 style="font-weight: bold; font-size: 1.5rem; margin-bottom: 20px;">Ops! Algo deu errado.</h2>
      <p style="margin-bottom: 10px;">Tente recarregar a página. Se o erro persistir, limpe o cache.</p>
      <pre id="error-message" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; font-size: 0.8rem;"></pre>
      <button onclick="localStorage.clear(); window.location.reload()" style="margin-top: 20px; padding: 12px 24px; background: white; color: #ef4444; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">
        Limpar Dados e Recarregar
      </button>
    </div>

    <script>
      setTimeout(() => {
        const btn = document.getElementById('reset-btn');
        if(btn) btn.style.display = 'block';
      }, 5000);

      window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('root').style.display = 'none';
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-message').innerText = message + '\n\nSource: ' + source + ':' + lineno;
      };
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module" data-presets="react">
      import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { 
        getFirestore, collection, addDoc, deleteDoc, doc, updateDoc,
        query, where, onSnapshot, orderBy, serverTimestamp 
      } from 'firebase/firestore';
      
      import { 
        Home, Users, ClipboardList, PieChart, Github, Scan, X, 
        CheckCircle, AlertTriangle, Plus, Trash2, Search, QrCode,
        UserCheck, UserX, Calendar, Sparkles, ScanLine, Download, 
        Check, X as XIcon, Settings, Database, Key, HelpCircle, ArrowRight, ExternalLink, Camera, Loader2, Edit2, BookOpen, Church, Clock
      } from 'lucide-react';
      
      import { 
        BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid 
      } from 'recharts';

      const CONFIG_KEY = 'pastoral_config_v7';

      const PastoralType = {
        CATEQUESE: "Catequese Infantil",
        CRISMA: "Crisma",
        EUCARISTIA: "Eucaristia",
        JOVENS: "Grupo de Jovens",
        OUTROS: "Outros"
      };

      const SetupScreen = ({ onSave }) => {
        const [apiKey, setApiKey] = useState('');
        const [fbConfig, setFbConfig] = useState('');
        const [error, setError] = useState('');
        
        const handleSave = () => {
          try {
            let configStr = fbConfig.trim();
            configStr = configStr.replace(/\/\/.*$/gm, '');
            if (configStr.includes('firebaseConfig')) {
                const match = configStr.match(/firebaseConfig\s*=\s*({[\s\S]*?});?/);
                if (match) configStr = match[1];
            } else if (!configStr.trim().startsWith('{')) {
                 const firstBrace = configStr.indexOf('{');
                 const lastBrace = configStr.lastIndexOf('}');
                 if (firstBrace !== -1 && lastBrace !== -1) configStr = configStr.substring(firstBrace, lastBrace + 1);
            }
            let parsed;
            try { parsed = new Function('return ' + configStr)(); } 
            catch (e) { if (!configStr.startsWith('{')) parsed = new Function('return {' + configStr + '}')(); else throw e; }
            if (!parsed || !parsed.projectId) throw new Error("Configuração incompleta.");

            localStorage.setItem(CONFIG_KEY, JSON.stringify({ geminiKey: apiKey, firebase: parsed }));
            window.location.reload(); 
          } catch (e) {
            console.error(e);
            setError("Erro ao ler código. Certifique-se de copiar o bloco: const firebaseConfig = { ... }");
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-900 to-slate-900 font-sans">
            <div className="bg-white rounded-2xl p-6 md:p-8 max-w-2xl w-full shadow-2xl animate-in">
              <div className="flex items-center gap-3 mb-6 border-b pb-4">
                <div className="p-3 bg-blue-100 rounded-lg text-blue-700"><Database size={24}/></div>
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">Conectar PastoralPass</h1>
                  <p className="text-gray-500 text-sm">Cole as chaves do seu banco de dados Firebase</p>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-6 md:gap-8">
                <div className="space-y-4">
                  <div>
                     <label className="text-xs uppercase font-bold text-gray-400 mb-2 block">Instruções</label>
                     <ol className="text-xs text-gray-600 space-y-2 list-decimal pl-4 bg-gray-50 p-3 rounded-lg border">
                        <li>No Firebase, vá em <strong>Configuração do SDK</strong>.</li>
                        <li>Marque a bolinha <strong>Config</strong>.</li>
                        <li>Copie o código: <code>const firebaseConfig = &#123; ... &#125;</code></li>
                     </ol>
                  </div>
                  <div>
                    <label className="text-xs uppercase font-bold text-gray-400 mb-1 block">Cole o código aqui:</label>
                    <textarea value={fbConfig} onChange={e => {setFbConfig(e.target.value); setError('');}} placeholder='const firebaseConfig = { ... }' className="w-full h-32 p-3 border rounded-lg text-xs font-mono bg-gray-900 text-green-400 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                    {error && <p className="text-red-500 text-xs font-bold mt-1">{error}</p>}
                  </div>
                </div>
                <div className="space-y-4 border-l pl-0 md:pl-8 border-gray-100 flex flex-col justify-between">
                   <div>
                    <label className="text-xs uppercase font-bold text-gray-400 mb-1 block">Opcional: Gemini API Key</label>
                    <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full p-3 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Para usar a IA (opcional)"/>
                  </div>
                  <button onClick={handleSave} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg hover:shadow-blue-500/30 flex justify-center items-center gap-2">Conectar Agora <ArrowRight size={18}/></button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /* COMPONENTE DE CÂMERA ISOLADO */
      const CameraZone = React.memo(({ onScanSuccess }) => {
          const callbackRef = useRef(onScanSuccess);
          
          useEffect(() => {
              callbackRef.current = onScanSuccess;
          }, [onScanSuccess]);

          useEffect(() => {
              console.log("Iniciando Câmera API Direta...");
              let html5QrCode = null;
              
              const timer = setTimeout(() => {
                  if (document.getElementById('reader')) {
                       html5QrCode = new Html5Qrcode("reader");
                       const config = { fps: 15, qrbox: 250 };
                       html5QrCode.start(
                           { facingMode: "environment" }, 
                           config,
                           (decodedText, decodedResult) => {
                               if(callbackRef.current) callbackRef.current(decodedText, decodedResult);
                           },
                           (errorMessage) => {}
                       ).catch((err) => {
                           console.error("Erro ao iniciar câmera", err);
                           const reader = document.getElementById('reader');
                           if(reader) reader.innerHTML = `<div class='p-4 text-center text-red-500 text-sm'>Erro ao acessar câmera: ${err.message || 'Permissão negada'}.<br/>Tente usar o código manual.</div>`;
                       });
                  }
              }, 300);

              return () => {
                  clearTimeout(timer);
                  if (html5QrCode) {
                      html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => console.error("Erro ao parar", err));
                  }
              };
          }, []);

          return (
              <div className="bg-black rounded-xl overflow-hidden mb-6 p-0 border-4 border-slate-900 relative min-h-[400px]">
                  <div id="reader" style={{width: '100%', minHeight: '400px', background: 'black'}}></div>
                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none text-white/50 text-xs">
                      <div className="flex flex-col items-center gap-2"><Loader2 className="animate-spin" />Acessando câmera...</div>
                  </div>
              </div>
          );
      }, () => true);

      /* MODAL DE HISTÓRICO COMPLETO DO ALUNO */
      const StudentHistoryModal = ({ student, allAttendance, onClose }) => {
          const history = useMemo(() => {
              return allAttendance
                  .filter(a => a.studentId === student.id)
                  .sort((a, b) => b.timestamp - a.timestamp);
          }, [student, allAttendance]);

          const stats = useMemo(() => {
              const totalAula = history.filter(a => a.type === 'AULA' || !a.type).length;
              const totalMissa = history.filter(a => a.type === 'MISSA').length;
              
              // Agrupamento por mês
              const byMonth = {};
              history.forEach(h => {
                  // data formato YYYY-MM-DD
                  const [y, m] = h.dateString.split('-'); 
                  const key = `${m}/${y}`;
                  if(!byMonth[key]) byMonth[key] = { aula: 0, missa: 0, name: new Date(h.dateString + 'T12:00:00').toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'}) };
                  if(h.type === 'MISSA') byMonth[key].missa++;
                  else byMonth[key].aula++;
              });

              return { totalAula, totalMissa, byMonth };
          }, [history]);

          return (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-sm">
                  <div className="bg-white w-full md:max-w-2xl md:rounded-2xl rounded-t-2xl h-[90vh] md:h-auto md:max-h-[90vh] flex flex-col shadow-2xl animate-in">
                      {/* Header */}
                      <div className="p-6 border-b flex justify-between items-start bg-slate-50 rounded-t-2xl">
                          <div>
                              <h2 className="text-2xl font-bold text-gray-800">{student.name}</h2>
                              <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold uppercase mt-1 inline-block">{student.pastoral}</span>
                              <p className="text-xs text-gray-500 mt-1 font-mono">ID: {student.qrCodeValue}</p>
                          </div>
                          <button onClick={onClose} className="bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition"><X size={20}/></button>
                      </div>

                      <div className="overflow-y-auto p-6 space-y-6">
                          {/* Cards Resumo */}
                          <div className="grid grid-cols-2 gap-4">
                              <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                  <div className="flex items-center gap-2 text-blue-600 mb-1"><BookOpen size={16}/><span className="text-xs font-bold uppercase">Aulas</span></div>
                                  <span className="text-3xl font-bold text-blue-800">{stats.totalAula}</span>
                              </div>
                              <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                  <div className="flex items-center gap-2 text-purple-600 mb-1"><Church size={16}/><span className="text-xs font-bold uppercase">Missas</span></div>
                                  <span className="text-3xl font-bold text-purple-800">{stats.totalMissa}</span>
                              </div>
                          </div>

                          {/* Frequência Mensal */}
                          <div>
                              <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2"><Calendar size={18}/> Frequência Mensal</h3>
                              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                  {Object.values(stats.byMonth).map((m, i) => (
                                      <div key={i} className="border rounded-lg p-3 text-sm">
                                          <div className="font-bold text-gray-800 capitalize mb-1">{m.name}</div>
                                          <div className="flex justify-between text-xs">
                                              <span className="text-blue-600">A: {m.aula}</span>
                                              <span className="text-purple-600">M: {m.missa}</span>
                                          </div>
                                      </div>
                                  ))}
                                  {Object.keys(stats.byMonth).length === 0 && <p className="text-gray-400 text-sm col-span-2">Sem registros ainda.</p>}
                              </div>
                          </div>

                          {/* Histórico Detalhado */}
                          <div>
                              <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2"><Clock size={18}/> Histórico Completo</h3>
                              <div className="border rounded-xl overflow-hidden">
                                  <table className="w-full text-left text-sm">
                                      <thead className="bg-gray-50 text-gray-500 font-bold text-xs uppercase">
                                          <tr><th className="p-3">Data</th><th className="p-3">Tipo</th><th className="p-3 text-right">Dia</th></tr>
                                      </thead>
                                      <tbody className="divide-y">
                                          {history.map(h => {
                                              const d = new Date(h.dateString + 'T12:00:00');
                                              return (
                                                  <tr key={h.id} className="hover:bg-gray-50">
                                                      <td className="p-3">{d.toLocaleDateString('pt-BR')}</td>
                                                      <td className="p-3">
                                                          {h.type === 'MISSA' 
                                                              ? <span className="text-purple-700 bg-purple-50 px-2 py-0.5 rounded text-xs font-bold">MISSA</span>
                                                              : <span className="text-blue-700 bg-blue-50 px-2 py-0.5 rounded text-xs font-bold">AULA</span>
                                                          }
                                                      </td>
                                                      <td className="p-3 text-right text-gray-400 text-xs capitalize">{d.toLocaleDateString('pt-BR', {weekday: 'short'})}</td>
                                                  </tr>
                                              );
                                          })}
                                          {history.length === 0 && <tr><td colSpan="3" className="p-4 text-center text-gray-400">Nenhum registro encontrado.</td></tr>}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      const App = () => {
        const [config, setConfig] = useState(null);
        const [db, setDb] = useState(null);
        const [initError, setInitError] = useState(null);
        const [activeTab, setActiveTab] = useState('dashboard');
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [modeSelectionOpen, setModeSelectionOpen] = useState(false);
        const [scannerOpen, setScannerOpen] = useState(false);
        const [selectedScanMode, setSelectedScanMode] = useState('AULA');
        const [students, setStudents] = useState([]);
        const [attendance, setAttendance] = useState([]);
        const [aiLoading, setAiLoading] = useState(false);
        const [aiResult, setAiResult] = useState('');

        useEffect(() => {
          const stored = localStorage.getItem(CONFIG_KEY);
          if (stored) {
            try {
              const parsed = JSON.parse(stored);
              setConfig(parsed);
              if (!parsed.firebase) throw new Error("Configuração do Firebase inválida.");
              
              let firebaseApp;
              try {
                firebaseApp = initializeApp(parsed.firebase);
              } catch (error) {
                if (error.code === 'app/duplicate-app') {
                   window.location.reload();
                   return;
                } else {
                   throw error;
                }
              }

              const firestore = getFirestore(firebaseApp);
              setDb(firestore);
              const unsubStudents = onSnapshot(collection(firestore, 'alunos'), (snap) => setStudents(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
              const unsubAttendance = onSnapshot(query(collection(firestore, 'presencas'), orderBy('timestamp', 'desc')), (snap) => setAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() }))), (error) => {
                  console.error("Firestore Error:", error);
                  if (error.code === 'permission-denied') alert("⚠️ PERMISSÃO NEGADA\n\nSeu banco de dados foi criado no Modo de Produção (Bloqueado).\n\nVá no console do Firebase > Firestore > Regras e altere 'allow read, write: if false' para 'if true'.");
              });
              return () => { unsubStudents(); unsubAttendance(); };
            } catch(e) { console.error("Init Error", e); setInitError(e.message || "Erro desconhecido na inicialização"); }
          }
        }, []);

        const handleAddStudent = async (data) => {
          if (!db) return;
          const qrCodeValue = data.qrCodeValue && data.qrCodeValue.trim() !== '' 
              ? data.qrCodeValue.trim()
              : Math.random().toString(36).substr(2, 9).toUpperCase();
              
          if (data.id) {
             await updateDoc(doc(db, 'alunos', data.id), { 
                 name: data.name, 
                 pastoral: data.pastoral, 
                 qrCodeValue: qrCodeValue
             });
          } else {
             await addDoc(collection(db, 'alunos'), { 
                 name: data.name, 
                 pastoral: data.pastoral, 
                 createdAt: serverTimestamp(), 
                 qrCodeValue: qrCodeValue 
             });
          }
        };

        const handleDeleteStudent = async (id) => { if(!db || !confirm("Excluir aluno permanentemente?")) return; await deleteDoc(doc(db, 'alunos', id)); };

        const handleMarkAttendance = async (scannedCode, type = 'AULA') => {
          if (!db) return;
          const cleanCode = scannedCode.trim().toLowerCase();
          
          const student = students.find(s => {
              const dbCode = (s.qrCodeValue || '').trim().toLowerCase();
              const studentId = s.id.toLowerCase();
              if (dbCode === cleanCode || studentId === cleanCode) return true;
              if (dbCode.length >= 2 && cleanCode.includes(dbCode)) return true;
              return false;
          });
          
          if (!student) throw new Error(`Aluno não encontrado (Lido: ${scannedCode})`);
          
          const today = new Date().toISOString().split('T')[0];
          
          const already = attendance.find(a => 
              a.studentId === student.id && 
              a.dateString === today && 
              (a.type === type || (!a.type && type === 'AULA'))
          );
          
          if (already) throw new Error(`${student.name} já registrado na ${type} hoje!`);
          
          await addDoc(collection(db, 'presencas'), { 
              studentId: student.id, 
              studentName: student.name, 
              pastoral: student.pastoral, 
              timestamp: Date.now(), 
              dateString: today,
              type: type // 'AULA' ou 'MISSA'
          });
          return student.name;
        };

        const handleAiAnalysis = async () => {
            if (!config?.geminiKey) return alert("Configure a API Key para usar este recurso.");
            setAiLoading(true);
            try {
                const prompt = `Analise estes dados de igreja: Temos ${students.length} alunos cadastrados. Hoje tivemos ${attendance.filter(a => a.dateString === new Date().toISOString().split('T')[0]).length} presenças. Gere 3 insights curtos e motivadores.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${config.geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) setAiResult(data.candidates[0].content.parts[0].text);
                else throw new Error("Falha na resposta da IA");
            } catch (err) { setAiResult("Erro ao conectar com a IA. Verifique sua chave de API."); }
            setAiLoading(false);
        };

        if (initError) return <div className="min-h-screen flex items-center justify-center p-4 bg-red-50 text-red-900"><div className="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border border-red-200"><div className="flex items-center gap-3 mb-4 text-red-600"><AlertTriangle size={32}/><h1 className="text-xl font-bold">Erro de Inicialização</h1></div><p className="mb-4 text-sm bg-red-50 p-3 rounded border border-red-100 font-mono break-all">{initError}</p><p className="mb-6 text-gray-600 text-sm">A configuração salva parece estar inválida ou o Firebase bloqueou a conexão.</p><button onClick={() => { localStorage.removeItem(CONFIG_KEY); window.location.reload(); }} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors">Resetar e Tentar Novamente</button></div></div>;

        if (!config) return <SetupScreen />;
        if (!db) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold flex-col gap-4"><div className="loader"></div><p>Sincronizando com a Nuvem...</p><button onClick={() => {localStorage.removeItem(CONFIG_KEY); window.location.reload()}} className="text-xs text-red-400 underline mt-4 hover:text-red-600">Cancelar e Resetar</button></div>;

        const Dashboard = () => {
            const today = new Date().toISOString().split('T')[0];
            const presentAula = attendance.filter(a => a.dateString === today && (a.type === 'AULA' || !a.type)).length;
            const presentMissa = attendance.filter(a => a.dateString === today && a.type === 'MISSA').length;
            const chartData = useMemo(() => {
                const days = [];
                for(let i=6; i>=0; i--) { 
                    const d = new Date(); d.setDate(d.getDate() - i); 
                    const ds = d.toISOString().split('T')[0]; 
                    days.push({ 
                        name: d.toLocaleDateString('pt-BR', {weekday: 'short'}), 
                        value: attendance.filter(a => a.dateString === ds && (a.type === 'AULA' || !a.type)).length 
                    }); 
                }
                return days;
            }, [attendance]);

            return (
                <div className="space-y-6 animate-in">
                    <h2 className="text-2xl font-bold text-gray-800">Painel Geral</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white p-5 rounded-xl border border-blue-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Total Alunos</p><h3 className="text-3xl font-bold text-blue-600 mt-1">{students.length}</h3></div>
                        <div className="bg-white p-5 rounded-xl border border-green-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Presença AULA</p><h3 className="text-3xl font-bold text-green-600 mt-1">{presentAula}</h3></div>
                        <div className="bg-white p-5 rounded-xl border border-purple-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Presença MISSA</p><h3 className="text-3xl font-bold text-purple-600 mt-1">{presentMissa}</h3></div>
                        <div className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm"><p className="text-gray-500 text-xs uppercase font-bold">Frequência (Aula)</p><h3 className="text-3xl font-bold text-gray-600 mt-1">{students.length ? Math.round((presentAula/students.length)*100) : 0}%</h3></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm h-72"><ResponsiveContainer width="100%" height="100%"><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6"/><XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill:'#9ca3af', fontSize:12}}/><Tooltip cursor={{fill: '#f9fafb'}} contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 6px -1px rgb(0 0 0 / 0.1)'}}/><Bar dataKey="value" fill="#3b82f6" radius={[4,4,0,0]} barSize={40}/></BarChart></ResponsiveContainer></div>
                </div>
            );
        };

        const StudentsList = () => {
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ id: null, name: '', pastoral: PastoralType.CATEQUESE, qrCodeValue: '' });
            const [search, setSearch] = useState('');
            const filtered = students.filter(s => s.name.toLowerCase().includes(search.toLowerCase()));
            const openEdit = (s) => { setForm({ id: s.id, name: s.name, pastoral: s.pastoral, qrCodeValue: s.qrCodeValue || '' }); setModal(true); };

            return (
                <div className="space-y-6 animate-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800">Alunos</h2><button onClick={() => {setForm({id: null, name:'', pastoral: PastoralType.CATEQUESE, qrCodeValue: ''}); setModal(true)}} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition font-medium text-sm"><Plus size={18}/> Novo Aluno</button></div>
                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                        <div className="p-4 border-b bg-gray-50/50"><div className="relative"><Search className="absolute left-3 top-2.5 text-gray-400" size={18}/><input type="text" placeholder="Buscar aluno..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-10 p-2 border rounded-lg bg-white text-sm focus:ring-2 focus:ring-blue-100 outline-none"/></div></div>
                        <div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-gray-50 text-gray-600 text-xs uppercase font-bold"><tr><th className="p-4">Nome</th><th className="p-4">Pastoral</th><th className="p-4">ID / QR</th><th className="p-4 text-right"></th></tr></thead><tbody className="divide-y text-sm">{filtered.map(s => (<tr key={s.id} className="hover:bg-gray-50 group"><td className="p-4 font-medium text-gray-900">{s.name}</td><td className="p-4"><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded-md text-xs font-semibold">{s.pastoral}</span></td><td className="p-4 font-mono text-gray-400 text-xs">{s.qrCodeValue}</td><td className="p-4 text-right flex justify-end gap-2"><button onClick={() => openEdit(s)} className="text-gray-300 hover:text-blue-600 transition"><Edit2 size={16}/></button><button onClick={() => handleDeleteStudent(s.id)} className="text-gray-300 hover:text-red-600 transition"><Trash2 size={16}/></button></td></tr>))}{filtered.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">Nenhum aluno encontrado.</td></tr>}</tbody></table></div>
                    </div>
                    {modal && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl p-6 w-full max-w-sm animate-in shadow-2xl"><h3 className="font-bold text-lg mb-4">{form.id ? 'Editar Aluno' : 'Adicionar Aluno'}</h3><div className="space-y-4"><input className="w-full p-3 border rounded-lg text-sm" placeholder="Nome Completo" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /><select className="w-full p-3 border rounded-lg bg-white text-sm" value={form.pastoral} onChange={e => setForm({...form, pastoral: e.target.value})}>{Object.values(PastoralType).map(p => <option key={p} value={p}>{p}</option>)}</select><input className="w-full p-3 border rounded-lg text-sm bg-gray-50" placeholder="Código do Crachá/QR (Opcional)" value={form.qrCodeValue} onChange={e => setForm({...form, qrCodeValue: e.target.value})} /><p className="text-xs text-gray-400">Dica: Se o crachá diz "01 FABRICIO", você pode salvar apenas "01" aqui.</p><div className="flex justify-end gap-2 mt-4 pt-4 border-t"><button onClick={() => setModal(false)} className="px-4 py-2 text-gray-500 text-sm hover:bg-gray-100 rounded-lg">Cancelar</button><button onClick={() => { handleAddStudent(form); setModal(false); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">Salvar</button></div></div></div></div>}
                </div>
            );
        };

        const Reports = () => {
             const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
             const [selectedStudent, setSelectedStudent] = useState(null); // Estado para o modal
             
             const list = useMemo(() => students.map(s => ({ 
                 ...s, 
                 presentAula: attendance.some(a => a.studentId === s.id && a.dateString === date && (a.type === 'AULA' || !a.type)),
                 presentMissa: attendance.some(a => a.studentId === s.id && a.dateString === date && a.type === 'MISSA')
             })), [students, attendance, date]);

             const exportCsv = () => { 
                 const csv = "data:text/csv;charset=utf-8," + ["Nome,Pastoral,Aula,Missa", ...list.map(l => `${l.name},${l.pastoral},${l.presentAula ? 'SIM' : 'NAO'},${l.presentMissa ? 'SIM' : 'NAO'}`)].join('\n'); 
                 const link = document.createElement("a"); 
                 link.href = encodeURI(csv); 
                 link.download = `relatorio_${date}.csv`; 
                 link.click(); 
             };

             return (
                <div className="space-y-6 animate-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800">Relatórios</h2><button onClick={exportCsv} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex gap-2 hover:bg-emerald-700 text-sm font-medium"><Download size={18}/> CSV</button></div>
                    <div className="bg-white p-4 rounded-xl border shadow-sm flex gap-3 items-center w-full md:w-auto self-start"><Calendar className="text-gray-400" size={20}/><input type="date" value={date} onChange={e => setDate(e.target.value)} className="outline-none text-gray-700 font-medium bg-transparent"/></div>
                    
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 text-gray-600 text-xs uppercase font-bold">
                                <tr>
                                    <th className="p-4">Aluno</th>
                                    <th className="p-4">Aula</th>
                                    <th className="p-4">Missa</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y text-sm">
                                {list.map(l => (
                                    <tr key={l.id}>
                                        <td 
                                            className="p-4 font-medium text-blue-600 hover:text-blue-800 cursor-pointer hover:underline"
                                            onClick={() => setSelectedStudent(l)}
                                        >
                                            {l.name}
                                        </td>
                                        <td className="p-4">{l.presentAula ? <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">PRESENTE</span> : <span className="text-gray-300">-</span>}</td>
                                        <td className="p-4">{l.presentMissa ? <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">PRESENTE</span> : <span className="text-gray-300">-</span>}</td>
                                    </tr>
                                ))}
                                {list.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-gray-400">Sem dados para esta data.</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {/* Modal de Detalhes do Aluno */}
                    {selectedStudent && (
                        <StudentHistoryModal 
                            student={selectedStudent} 
                            allAttendance={attendance} 
                            onClose={() => setSelectedStudent(null)} 
                        />
                    )}
                </div>
             );
        };

        const ScannerSelectionModal = ({ onClose, onSelect }) => {
            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                     <button onClick={onClose} className="absolute top-6 right-6 text-white/50 hover:text-white z-50 p-2"><X size={32}/></button>
                     <div className="bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-8 w-full max-w-sm animate-in text-center">
                         <h3 className="text-white text-xl font-bold mb-8">O que vamos registrar?</h3>
                         <div className="flex flex-col gap-4">
                             <button onClick={() => onSelect('AULA')} className="bg-blue-600 hover:bg-blue-500 text-white p-6 rounded-xl font-bold text-lg flex items-center justify-center gap-4 transition-all hover:scale-105 shadow-xl shadow-blue-900/50">
                                 <BookOpen size={28}/> CHAMADA AULA
                             </button>
                             <button onClick={() => onSelect('MISSA')} className="bg-purple-600 hover:bg-purple-500 text-white p-6 rounded-xl font-bold text-lg flex items-center justify-center gap-4 transition-all hover:scale-105 shadow-xl shadow-purple-900/50">
                                 <Church size={28}/> CHAMADA MISSA
                             </button>
                         </div>
                     </div>
                </div>
            );
        };

        const ScannerModal = ({ onClose, mode }) => {
            const [val, setVal] = useState('');
            const [status, setStatus] = useState('idle');
            const [msg, setMsg] = useState('');

            const handleClose = () => {
                onClose();
            };

            const handleCode = async (code) => {
                try {
                    const name = await handleMarkAttendance(code, mode);
                    setStatus('success');
                    setMsg(name);
                    setTimeout(() => { setStatus('idle'); setVal(''); setMsg(''); /* handleClose(); remove to allow continuous scan */ }, 1500);
                } catch (err) {
                    setStatus('error');
                    setMsg(err.message);
                }
            };

            const submit = (e) => { e.preventDefault(); if(val) handleCode(val); };

            const onScanSuccess = useCallback((decodedText) => {
                 handleCode(decodedText);
            }, []); 

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <div className="absolute top-0 left-0 right-0 p-4 z-50 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
                         <div className={`px-4 py-2 rounded-full backdrop-blur-md font-bold text-sm flex items-center gap-2 border shadow-lg ${mode === 'AULA' ? 'bg-blue-600/80 border-blue-400 text-white' : 'bg-purple-600/80 border-purple-400 text-white'}`}>
                             {mode === 'AULA' ? <BookOpen size={16}/> : <Church size={16}/>} 
                             Registrando: {mode}
                         </div>
                         <button onClick={handleClose} className="bg-black/40 hover:bg-black/60 text-white p-2 rounded-full backdrop-blur-md transition"><X size={24}/></button>
                    </div>

                    <div className="flex-1 relative flex items-center justify-center bg-black">
                        {/* Indicador de Status Central */}
                        {(status === 'success' || status === 'error') && (
                            <div className="absolute z-40 inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in">
                                 <div className={`p-8 rounded-3xl flex flex-col items-center gap-4 shadow-2xl ${status === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>
                                     {status === 'success' ? <CheckCircle size={64}/> : <AlertTriangle size={64}/>}
                                     <span className="text-xl font-bold text-center">{msg}</span>
                                 </div>
                            </div>
                        )}
                        
                        {/* CÂMERA BLINDADA */}
                        <div className="absolute inset-0">
                            <CameraZone onScanSuccess={onScanSuccess} />
                        </div>
                    </div>
                    
                    <div className="p-4 bg-black pb-8">
                         <form onSubmit={submit} className="relative max-w-sm mx-auto">
                            <input id="scanInput" value={val} onChange={e => setVal(e.target.value)} className="w-full bg-slate-800/80 border border-slate-700 rounded-full px-6 py-3 text-center text-white placeholder-slate-500 focus:border-blue-500 outline-none backdrop-blur-sm" placeholder="Digitar código manual..." autoComplete="off"/>
                         </form>
                    </div>
                </div>
            );
        };

        return (
          <div className="flex min-h-screen bg-gray-50 text-gray-900 font-sans">
            {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden backdrop-blur-sm" onClick={() => setSidebarOpen(false)}/>}
            <aside className={`fixed md:static inset-y-0 left-0 z-40 w-64 bg-slate-900 text-white transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 flex flex-col shadow-xl`}>
                <div className="h-16 flex items-center px-6 border-b border-slate-800 font-bold text-lg tracking-wide bg-slate-950"><div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3"><CheckCircle size={20}/></div>PastoralPass</div>
                <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                    {[{id: 'dashboard', icon: Home, label: 'Painel'},{id: 'students', icon: Users, label: 'Alunos'},{id: 'reports', icon: ClipboardList, label: 'Relatórios'},{id: 'insights', icon: Sparkles, label: 'IA Insights'},{id: 'settings', icon: Settings, label: 'Configuração'}].map(i => (<button key={i.id} onClick={() => {setActiveTab(i.id); setSidebarOpen(false)}} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all font-medium ${activeTab === i.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 translate-x-1' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i.icon size={20}/> {i.label}</button>))}
                </nav>
            </aside>
            <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                <header className="h-16 bg-white border-b flex items-center px-4 justify-between md:hidden z-20 sticky top-0"><button onClick={() => setSidebarOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg"><Database size={24}/></button><span className="font-bold text-slate-800">PastoralPass</span><div className="w-8"></div></header>
                <div className="flex-1 overflow-auto p-4 md:p-8 pb-24 scroll-smooth">
                    <div className="max-w-6xl mx-auto">
                        {activeTab === 'dashboard' && <Dashboard />}
                        {activeTab === 'students' && <StudentsList />}
                        {activeTab === 'reports' && <Reports />}
                        {activeTab === 'insights' && (
                            <div className="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 rounded-2xl shadow-xl animate-in relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div><h2 className="text-2xl font-bold flex gap-2 items-center mb-4 relative z-10"><Sparkles className="text-yellow-300"/> Inteligência Pastoral</h2><p className="mb-6 opacity-90 relative z-10 max-w-lg">Utilize o poder do Google Gemini para analisar tendências de frequência e receber conselhos pastorais.</p><button onClick={handleAiAnalysis} disabled={aiLoading} className="relative z-10 bg-white text-indigo-700 px-6 py-3 rounded-xl font-bold hover:shadow-lg transition disabled:opacity-70 flex items-center gap-2">{aiLoading ? <div className="loader w-4 h-4 border-indigo-600 border-t-transparent"></div> : <Sparkles size={18}/>}{aiLoading ? 'Analisando dados...' : 'Gerar Relatório IA'}</button>{aiResult && <div className="mt-8 bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20 leading-relaxed shadow-inner animate-in relative z-10">{aiResult}</div>}
                            </div>
                        )}
                        {activeTab === 'settings' && (
                            <div className="bg-white p-6 rounded-xl border border-red-100 shadow-sm animate-in">
                                <h2 className="text-xl font-bold mb-4 text-red-600 flex items-center gap-2"><AlertTriangle/> Zona de Perigo</h2>
                                <p className="text-gray-600 mb-6">Ao desconectar, você removerá as chaves de acesso deste dispositivo. Os dados no Firebase permanecerão seguros.</p>
                                <button onClick={() => {localStorage.removeItem(CONFIG_KEY); window.location.reload()}} className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl hover:bg-red-100 font-bold w-full md:w-auto transition-colors">Desconectar Banco de Dados</button>
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Botão Flutuante de Scanner (Abre Seleção) */}
                <button onClick={() => setModeSelectionOpen(true)} className="fixed bottom-6 right-6 md:bottom-8 md:right-8 bg-blue-600 text-white p-4 rounded-2xl shadow-xl shadow-blue-600/40 hover:scale-110 transition-all active:scale-95 z-30 group"><ScanLine size={32} className="group-hover:rotate-90 transition-transform duration-500"/></button>
            </main>
            
            {/* Modal de Seleção (Passo 1) */}
            {modeSelectionOpen && (
                <ScannerSelectionModal 
                    onClose={() => setModeSelectionOpen(false)}
                    onSelect={(mode) => {
                        setSelectedScanMode(mode);
                        setModeSelectionOpen(false);
                        setScannerOpen(true);
                    }}
                />
            )}
            
            {/* Modal de Câmera (Passo 2) */}
            {scannerOpen && <ScannerModal mode={selectedScanMode} onClose={() => setScannerOpen(false)} />}
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
